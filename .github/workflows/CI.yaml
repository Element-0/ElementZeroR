name: CI

env:
  bds_version: 1.16.201.02
  nim_version: 1.4.2

on:
  push:
    branches: [ ðŸ’¥ ]
  pull_request:
    branches: [ ðŸ’¥ ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Download rcedit.exe
        uses: robinraju/release-downloader@v1
        with:
          repository: electron/rcedit
          latest: true
          fileName: rcedit-x64.exe
          out-file-path: ${{ runner.tool_cache }}/rcedit
      - name: Setup rcedit
        run: |
          Rename-Item ${{ runner.tool_cache }}\rcedit\rcedit-x64.exe ${{ runner.tool_cache }}\rcedit\rcedit.exe
          echo "${{ runner.tool_cache }}\rcedit" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: Set up Visual Studio shell
        uses: egor-tensin/vs-shell@v2
      - name: Install nim
        uses: jiro4989/setup-nim-action@v1
        with:
          nim-version: ${{ env.nim_version }}
      - name: Install dependencies
        run: |
          Write-Output "::group::Refresh nimble database"
          nimble.exe refresh
          Write-Output "::endgroup::"
          Write-Output "::group::Install nimake"
          nimble.exe install https://github.com/codehz/nimake@#v0.5.0
          Write-Output "::endgroup::"
          Write-Output "::group::Install winim vtable xmlio"
          nimble.exe install -y winim vtable@0.3.2 xmlio@0.1.9
          Write-Output "::endgroup::"
      - name: Download BuildXL
        uses: carlosperate/download-file-action@v1.0.3
        id: download-buildxl
        with:
          file-url: 'https://dl.lumito.net/public/projects/BuildXL/0.1.0/msi/20201107.0/BuildXL.Setup.0.1.0-20201107.0.msi'
          file-name: 'BuildXL.Setup.msi'
          location: ${{ runner.tool_cache }}
      - name: Install BuildXL
        run: |
          Write-Output "::group::Run msiexec"
          msiexec /i ${{ steps.download-buildxl.outputs.file-path }} /qn
          Write-Output "::endgroup::"
          Write-Output "::group::Setting environment variables"
          echo "C:\Program Files\BuildXL\" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "BUILDXL_BIN=C:\Program Files\BuildXL\" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CHOOSENIM=$env:USERPROFILE\.choosenim" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "NIMPATH=$env:USERPROFILE\.choosenim\toolchains\nim-${{ env.nim_version }}\bin\nim.exe" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "NIMBLEPATH=$env:USERPROFILE\.nimble\pkgs" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "::endgroup::"
      - name: Run BuildXL
        run: |
          bxl /c:config.dsc